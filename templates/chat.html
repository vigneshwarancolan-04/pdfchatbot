<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat with PDF - {{ session_id[:8] }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- MathJax for formulas -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <style>
    body { height: 100vh; display: flex; overflow: hidden; margin: 0; }
    .sidebar { width: 250px; background: #f8f9fa; padding: 1rem; border-right: 1px solid #ccc; overflow-y: auto; }
    .chat-area { flex: 1; display: flex; flex-direction: column; }
    .chat-history { flex: 1; padding: 1rem; overflow-y: auto; background: white; }
    .chat-entry { margin-bottom: 1rem; }
    .question, .answer { padding: 10px; border-radius: 6px; margin-top: 4px; white-space: pre-wrap; }
    .question { background: #e3f2fd; }
    .answer { background: #e8f5e9; }
    .chat-box { padding: 1rem; background: #f1f1f1; border-top: 1px solid #ccc; }
    .form-small { font-size: 0.9rem; margin-top: 1rem; }
    .list-group-item.active a { text-decoration: none; color: white; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <form action="/" method="POST" enctype="multipart/form-data" class="form-small mb-3">
      <label class="form-label fw-bold">Start New Chat</label>
      <input type="file" name="pdf" class="form-control form-control-sm mb-2" required>
      <button type="submit" class="btn btn-sm btn-primary w-100">Upload PDF</button>
    </form>

    <h5>üìÅ Sessions</h5>
    <ul class="list-group">
      {% for session in sessions %}
        <li class="list-group-item {% if session.id == session_id %}active{% endif %}">
          <a href="{{ url_for('chat', session_id=session.id) }}" class="text-decoration-none {% if session.id == session_id %}text-white{% else %}text-dark{% endif %}">
            {{ session.title }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div class="chat-history" id="chat-history">
      <h5 class="mb-3">üß† Chatting with PDF</h5>
      {% if history %}
        {% for chat in history %}
          <div class="chat-entry">
            <div class="question"><strong>You:</strong> {{ chat.question }}</div>
            <div class="answer"><strong>Assistant:</strong>
              <div class="markdown-content">{{ chat.answer }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No messages yet. Ask a question!</p>
      {% endif %}
    </div>

    <div class="chat-box">
      <form method="POST" class="d-flex">
        <input type="text" class="form-control me-2" name="question" placeholder="Ask a question..." required autocomplete="off" autofocus />
        <button class="btn btn-primary" type="submit">Send</button>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    window.onload = () => {
      const chatHistory = document.getElementById('chat-history');
      chatHistory.scrollTop = chatHistory.scrollHeight;

      // Convert all assistant answers from Markdown to HTML
      document.querySelectorAll('.markdown-content').forEach(el => {
        el.innerHTML = marked.parse(el.textContent);
      });

      // Render MathJax formulas
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    };
  </script>
</body>
</html>
